minimum_cumulusci_version: "3.26.0"
project:
    name: atlas-dog
    package:
        name: AtlasDogs
        namespace: atlas1
        api_version: "54.0"
    dependencies:
        - github: "https://github.com/SalesforceFoundation/NPSP"
        - github: "https://github.com/SalesforceFoundation/Volunteers-for-Salesforce"
    git:
        default_branch: "dev"
    source_format: sfdx

tasks:
    robot:
        options:
            suites: robot/atlas-dog/tests
            options:
                outputdir: robot/atlas-dog/results

    robot_testdoc:
        options:
            path: robot/atlas-dog/tests
            output: robot/atlas-dog/doc/atlas-dog_tests.html

    run_tests:
        options:
            managed: true

    create_package_version:
        options:
            create_unlocked_dependency_packages: True

    uninstall_packaged_incremental:
        options:
            ignore_types:
                ["RecordType", "CustomObjectTranslation", "QuickAction"]

flows:
    config_qa:
        steps:
            3:
                task: assign_permission_sets
                options:
                    api_names: Atlas_Super_User

    config_dev:
        steps:
            1: # for now, use mdapi deploy for post, since it isn't tied to our namespace
                task: dx
                options:
                    command: force:mdapi:deploy -d unpackaged/post
            3:
                task: assign_permission_sets
                options:
                    api_names: AtlasSuperUser
            4:
                task: load_dataset

    dev_org:
        steps:
            3.1:
                task: dx_push
                when: project_config.project__source_format == "sfdx" and org_config.scratch

    # Flow to deploy current source to a sandbox for dev or verification
    sandbox:
        steps:
            1:
                flow: dependencies
            2:
                task: dx
                options:
                    command: force:source:deploy
                    extra: -p force-app/main/default

    release_2gp_beta:
        steps:
            1:
                task: create_package_version
                options:
                    create_unlocked_dependency_packages: True
                    package_type: Managed
                    package_name: $project_config.project__package__name
                    skip_validation: False
                    ancestor_id: latest_github_release
                    version_base: latest_github_release
                    version_type: minor
                    force_upload: True

orgs:
    scratch:
        build:
            config_file: orgs/build.json

sources:
    npsp:
        github: https://github.com/SalesforceFoundation/NPSP
