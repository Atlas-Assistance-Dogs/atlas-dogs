name: Deploy to Sandbox

on:
    push:
        branches:
            - dev
            - feature/3-github-actions

env:
    CUMULUSCI_KEYCHAIN_CLASS: cumulusci.core.keychain.EnvironmentProjectKeychain
    CUMULUSCI_SERVICE_github: ${{ secrets.CUMULUSCI_SERVICE_github }}

jobs:
    deploy_to_sandbox:
        name: "Deploy to sandbox"
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - name: Install sfdx
              uses: ../actions/install-sfdx
              with:
                  auth_url: ${{ secrets.SFDX_AUTH_URL }}
            - name: Set up Python
              uses: actions/setup-python@v1
              with:
                  python-version: "3.8"
            - name: Install CumulusCI
              run: |
                  python -m pip install -U pip
                  pip install cumulusci
            - name: Authorize the sandbox
              run: |
                  'echo "$SSH_KEY" > key'
                  sfdx auth:jwt:grant --clientid $CONSUMER_KEY --username $HUB_USERNAME --jwtkeyfile key --setdefaultusername
              shell: bash
              env:
                  SSH_KEY: ${{secrets.SSH_KEY}}
                  CONSUMER_KEY: ${{secrets.SANDBOX_CLIENT_ID}}
                  HUB_USERNAME: ${{secrets.DEVUSER}}
            - run: |
                  cci flow run sandbox --org sandbox
